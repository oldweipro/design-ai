{{define "pages/dashboard"}}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户仪表板 - DesignAI</title>
    
    <!-- 引用新的CSS文件 -->
    <link rel="stylesheet" href="/assets/css/common.css">
    <link rel="stylesheet" href="/assets/css/dashboard.css">
</head>
<body>
    <!-- 侧边栏 -->
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <a href="/" class="sidebar-logo">
                <div class="logo-icon">🎨</div>
                <span>DesignAI</span>
            </a>
        </div>

        <nav class="sidebar-nav">
            <!-- 主要功能 -->
            <div class="nav-section">
                <div class="nav-title">主要功能</div>
                <a href="#dashboard" class="nav-item active" data-section="dashboard">
                    <span class="nav-icon">📊</span>
                    <span>仪表板</span>
                </a>
                <a href="#my-portfolios" class="nav-item" data-section="my-portfolios">
                    <span class="nav-icon">🎨</span>
                    <span>我的作品</span>
                </a>
                <a href="#create-portfolio" class="nav-item" data-section="create-portfolio">
                    <span class="nav-icon">➕</span>
                    <span>创建作品</span>
                </a>
            </div>

            <!-- 管理员功能 -->
            <div class="nav-section" id="adminSection" style="display: none;">
                <div class="nav-title">管理员功能</div>
                <a href="#user-management" class="nav-item" data-section="user-management">
                    <span class="nav-icon">👥</span>
                    <span>用户管理</span>
                </a>
                <a href="#portfolio-review" class="nav-item" data-section="portfolio-review">
                    <span class="nav-icon">🔍</span>
                    <span>作品审核</span>
                </a>
                <a href="#system-settings" class="nav-item" data-section="system-settings">
                    <span class="nav-icon">🛠️</span>
                    <span>系统设置</span>
                </a>
                <a href="#minio-settings" class="nav-item" data-section="minio-settings">
                    <span class="nav-icon">📁</span>
                    <span>MinIO设置</span>
                </a>
            </div>

            <!-- 其他 -->
            <div class="nav-section">
                <div class="nav-title">其他</div>
                <a href="#settings" class="nav-item" data-section="settings">
                    <span class="nav-icon">⚙️</span>
                    <span>设置</span>
                </a>
                <a href="#profile" class="nav-item" data-section="profile">
                    <span class="nav-icon">👤</span>
                    <span>个人资料</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="user-profile">
                <div id="userAvatar" class="user-avatar">U</div>
                <div class="user-info">
                    <h4 id="userName">用户名</h4>
                    <p id="userStatus">用户</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- 主内容区域 -->
    <div id="mainContent" class="main-content">
        <!-- 顶部栏 -->
        <header class="top-bar">
            <div class="top-bar-left">
                <button class="mobile-menu-btn">☰</button>
                <h1 id="pageTitle" class="page-title">仪表板</h1>
            </div>

            <div class="top-actions">
                <button class="theme-toggle" aria-label="切换主题">
                    <span id="themeIcon">🌙</span>
                </button>
                
                <div class="user-actions">
                    <button class="btn btn-secondary" onclick="logout()" title="退出登录">
                        <span>🚪</span>
                        <span class="desktop-only">退出</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- 页面内容 -->
        <div class="dashboard-content">
            <!-- 仪表板主页 -->
            <div id="dashboard-section" class="content-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">总作品数</span>
                            <span class="stat-icon">🎨</span>
                        </div>
                        <div class="stat-value" id="totalPortfolios">0</div>
                        <div class="stat-change positive">
                            <span>📈</span>
                            <span>本月新增</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">已发布</span>
                            <span class="stat-icon">✅</span>
                        </div>
                        <div class="stat-value" id="publishedPortfolios">0</div>
                        <div class="stat-change positive">
                            <span>🚀</span>
                            <span>作品发布</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">总浏览量</span>
                            <span class="stat-icon">👁️</span>
                        </div>
                        <div class="stat-value" id="totalViews">0</div>
                        <div class="stat-change positive">
                            <span>📊</span>
                            <span>持续增长</span>
                        </div>
                    </div>
                </div>

                <div class="main-sections">
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">最近作品</h2>
                            <a href="#my-portfolios" class="btn btn-secondary">查看全部</a>
                        </div>
                        <div id="recentPortfolios" class="portfolio-list">
                            <div class="loading">
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                                <span style="margin-left: 1rem;">加载中...</span>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">最近活动</h2>
                        </div>
                        <div id="recentActivity" class="activity-list">
                            <div class="loading">
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                                <span style="margin-left: 1rem;">加载活动...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MinIO设置页面 -->
            <div id="minio-settings-section" class="content-section" style="display: none;">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">MinIO存储配置</h2>
                        <button class="btn btn-primary" onclick="showAddMinioConfig()">
                            <span>➕</span>
                            <span>添加配置</span>
                        </button>
                    </div>
                    
                    <div id="minioConfigsList">
                        <div class="loading">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <span style="margin-left: 1rem;">加载配置...</span>
                        </div>
                    </div>
                </div>

                <!-- 文件管理区域 -->
                <div class="section" style="margin-top: 2rem;">
                    <div class="section-header">
                        <h2 class="section-title">文件管理</h2>
                        <div class="section-actions">
                            <button class="btn btn-success" onclick="showUploadModal()">
                                <span>📤</span>
                                <span>上传文件</span>
                            </button>
                            <button class="btn btn-secondary" onclick="refreshFileList()">
                                <span>🔄</span>
                                <span>刷新</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="file-stats">
                        <div class="stat-item">
                            <span class="stat-label">总文件数:</span>
                            <span class="stat-value" id="totalFilesCount">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">总大小:</span>
                            <span class="stat-value" id="totalFilesSize">0 B</span>
                        </div>
                    </div>

                    <div id="filesList">
                        <div class="loading">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <span style="margin-left: 1rem;">加载文件列表...</span>
                        </div>
                    </div>
                </div>
                
                <!-- MinIO配置模态框 -->
                <div id="minioConfigModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title" id="minioModalTitle">添加MinIO配置</h3>
                            <button class="close-btn" onclick="closeMinioModal()">&times;</button>
                        </div>
                        
                        <form id="minioConfigForm">
                            <input type="hidden" id="minioConfigId" name="id">
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">配置名称</label>
                                    <input type="text" class="form-input" name="name" id="minioName" placeholder="例如：生产环境MinIO" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">服务端点</label>
                                    <input type="text" class="form-input" name="endpoint" id="minioEndpoint" placeholder="例如：minio.example.com:9000" required>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">访问密钥 (Access Key)</label>
                                    <input type="text" class="form-input" name="access_key" id="minioAccessKey" placeholder="访问密钥" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">秘密密钥 (Secret Key)</label>
                                    <input type="password" class="form-input" name="secret_key" id="minioSecretKey" placeholder="秘密密钥">
                                    <small style="color: var(--text-secondary); margin-top: 0.5rem; display: block;" id="secretKeyHint">编辑时留空表示不更改现有密钥</small>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">存储桶名称</label>
                                    <input type="text" class="form-input" name="bucket_name" id="minioBucket" placeholder="例如：design-files" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">区域</label>
                                    <input type="text" class="form-input" name="region" id="minioRegion" placeholder="us-east-1" value="us-east-1">
                                </div>
                            </div>
                            
                            <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: space-between;">
                                <button type="button" class="btn btn-secondary" onclick="testMinioConnection()">
                                    <span>🔧</span>
                                    <span>测试连接</span>
                                </button>
                                <div style="display: flex; gap: 1rem;">
                                    <button type="button" class="btn btn-secondary" onclick="closeMinioModal()">取消</button>
                                    <button type="submit" class="btn btn-primary">
                                        <span>💾</span>
                                        <span>保存配置</span>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 文件上传模态框 -->
                <div id="uploadModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">上传文件</h3>
                            <button class="close-btn" onclick="closeUploadModal()">&times;</button>
                        </div>
                        
                        <form id="fileUploadForm" enctype="multipart/form-data">
                            <div class="upload-area">
                                <div class="upload-zone" id="uploadZone">
                                    <div class="upload-icon">📁</div>
                                    <p class="upload-text">点击或拖拽文件到此处上传</p>
                                    <p class="upload-hint">支持图片、文档、视频等格式，单个文件最大100MB</p>
                                    <input type="file" id="fileInput" multiple accept="*/*" style="display: none;">
                                </div>
                            </div>

                            <div id="filePreview" class="file-preview" style="display: none;">
                                <h4>选择的文件:</h4>
                                <div id="selectedFiles" class="selected-files"></div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">文件标签</label>
                                <input type="text" class="form-input" id="fileTags" placeholder="用逗号分隔，如：图片, 设计, 素材">
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="isPublic" style="margin-right: 0.5rem;">
                                    公开文件（其他用户可访问）
                                </label>
                            </div>

                            <div class="upload-progress" id="uploadProgress" style="display: none;">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill"></div>
                                </div>
                                <div class="progress-text" id="progressText">0%</div>
                            </div>

                            <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
                                <button type="button" class="btn btn-secondary" onclick="closeUploadModal()">取消</button>
                                <button type="submit" class="btn btn-primary" id="uploadBtn">
                                    <span>📤</span>
                                    <span>开始上传</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 我的作品页面 -->
            <div id="my-portfolios-section" class="content-section" style="display: none;">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">我的作品</h2>
                        <div class="section-actions">
                            <select id="statusFilter" class="form-input" style="width: auto;">
                                <option value="">全部状态</option>
                                <option value="published">已发布</option>
                                <option value="draft">草稿</option>
                                <option value="rejected">已拒绝</option>
                            </select>
                            <button class="btn btn-primary" onclick="dashboardManager.showSection('create-portfolio')">
                                <span>➕</span>
                                <span>创建作品</span>
                            </button>
                        </div>
                    </div>
                    <div id="allPortfolios" class="portfolio-list">
                        <div class="loading">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <span style="margin-left: 1rem;">加载作品...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 创建作品页面 -->
            <div id="create-portfolio-section" class="content-section" style="display: none;">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">创建新作品</h2>
                    </div>
                    
                    <form id="createPortfolioForm" style="max-width: 800px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                            <div class="form-group">
                                <label class="form-label">作品标题</label>
                                <input type="text" class="form-input" name="title" placeholder="输入作品标题" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">作品分类</label>
                                <select class="form-input" name="category" required>
                                    <option value="">选择分类</option>
                                    <option value="ai">AI生成</option>
                                    <option value="ui">UI设计</option>
                                    <option value="web">网页设计</option>
                                    <option value="mobile">移动端设计</option>
                                    <option value="brand">品牌设计</option>
                                    <option value="3d">3D设计</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group" style="margin-bottom: 2rem;">
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--text-accent);">
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">
                                    📝 <strong>作者信息</strong>：作品作者将自动使用您的昵称（如未设置昵称则使用用户名）
                                </p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">作品描述</label>
                            <textarea class="form-input" name="description" rows="4" placeholder="描述您的作品..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">作品版本</label>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <select class="form-input" name="portfolioVersion" id="portfolioVersion" style="flex: 1;">
                                    <option value="">选择或创建版本</option>
                                </select>
                                <button type="button" class="btn btn-sm btn-primary" onclick="showAddVersionDialog()">
                                    <span>➕</span> 新版本
                                </button>
                                <button type="button" class="btn btn-sm btn-danger" onclick="deleteSelectedVersion()" id="deleteVersionBtn" style="display: none;">
                                    <span>🗑️</span> 删除
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">HTML展示内容</label>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <div style="display: flex; gap: 1rem; margin-bottom: 0.5rem;">
                                    <button type="button" onclick="toggleCodeEditor()" style="padding: 0.5rem 1rem; border: 1px solid var(--border-color); background: var(--bg-secondary); border-radius: 6px; font-size: 0.9rem; cursor: pointer;">
                                        <span id="editorToggleText">📝 显示代码编辑器</span>
                                    </button>
                                    <button type="button" onclick="previewHTML()" style="padding: 0.5rem 1rem; border: 1px solid var(--border-color); background: var(--bg-secondary); border-radius: 6px; font-size: 0.9rem; cursor: pointer;">
                                        👁️ 预览
                                    </button>
                                </div>
                                <textarea class="form-input" name="htmlContent" id="htmlContentEditor" rows="12" placeholder="输入HTML代码（用于前台展示）..." style="font-family: 'Monaco', 'Consolas', 'Courier New', monospace; font-size: 0.9rem; display: none;"></textarea>
                                <div id="htmlPreview" style="border: 1px solid var(--border-color); border-radius: 8px; min-height: 300px; background: white; display: none; overflow: auto;">
                                    <iframe id="previewFrame" style="width: 100%; height: 300px; border: none;"></iframe>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                            <div class="form-group">
                                <label class="form-label">作品图片URL</label>
                                <input type="url" class="form-input" name="imageUrl" placeholder="https://example.com/image.jpg">
                            </div>
                            <div class="form-group">
                                <label class="form-label">AI参与程度</label>
                                <select class="form-input" name="aiLevel" required>
                                    <option value="AI完全生成">AI完全生成</option>
                                    <option value="AI辅助设计">AI辅助设计</option>
                                    <option value="手工设计">手工设计</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">标签</label>
                            <input type="text" class="form-input" name="tags" placeholder="用逗号分隔，如：现代, 简约, 创意">
                        </div>

                        <div style="margin-top: 3rem; display: flex; gap: 1rem;">
                            <button type="button" class="btn btn-secondary" onclick="dashboardManager.showSection('my-portfolios')">取消</button>
                            <button type="submit" class="btn btn-primary" onclick="handleCreatePortfolio(event)">
                                <span>💾</span>
                                <span>保存作品</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 编辑作品页面 -->
            <div id="edit-portfolio-section" class="content-section" style="display: none;">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">编辑作品</h2>
                    </div>
                    
                    <form id="editPortfolioForm" style="max-width: 800px;">
                        <input type="hidden" id="editPortfolioId" name="id">
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                            <div class="form-group">
                                <label class="form-label">作品标题</label>
                                <input type="text" class="form-input" id="editTitle" name="title" placeholder="输入作品标题" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">作品分类</label>
                                <select class="form-input" id="editCategory" name="category" required>
                                    <option value="">选择分类</option>
                                    <option value="ai">AI生成</option>
                                    <option value="ui">UI设计</option>
                                    <option value="web">网页设计</option>
                                    <option value="mobile">移动端设计</option>
                                    <option value="brand">品牌设计</option>
                                    <option value="3d">3D设计</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group" style="margin-bottom: 2rem;">
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--text-accent);">
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">
                                    📝 <strong>作者信息</strong>：作品作者将自动更新为您当前的昵称
                                </p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">作品描述</label>
                            <textarea class="form-input" id="editDescription" name="description" rows="4" placeholder="描述您的作品..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">作品内容</label>
                            <textarea class="form-input" id="editContent" name="content" rows="8" placeholder="详细介绍您的设计理念、制作过程等..."></textarea>
                        </div>
                        
                        <!-- HTML内容编辑器 -->
                        <div class="form-group">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <label class="form-label" style="margin: 0;">HTML代码</label>
                                <button type="button" id="toggleHtmlEditorEdit" class="btn btn-sm btn-secondary">
                                    <span>📝</span> 显示HTML编辑器
                                </button>
                                <button type="button" id="previewHtmlEdit" class="btn btn-sm btn-primary" style="display: none;">
                                    <span>👁️</span> 预览
                                </button>
                            </div>
                            <div id="htmlEditorContainerEdit" style="display: none;">
                                <textarea class="form-input" id="editHtmlContent" name="htmlContent" rows="15" placeholder="输入您的HTML代码..." style="font-family: monospace; font-size: 14px;"></textarea>
                                <div style="margin-top: 1rem;">
                                    <div style="border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); height: 300px; overflow: hidden;">
                                        <iframe id="htmlPreviewEdit" style="width: 100%; height: 100%; border: none; background: white;"></iframe>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                            <div class="form-group">
                                <label class="form-label">作品图片URL</label>
                                <input type="url" class="form-input" id="editImageUrl" name="imageUrl" placeholder="https://example.com/image.jpg">
                            </div>
                            <div class="form-group">
                                <label class="form-label">AI参与程度</label>
                                <select class="form-input" id="editAiLevel" name="aiLevel" required>
                                    <option value="AI完全生成">AI完全生成</option>
                                    <option value="AI辅助设计">AI辅助设计</option>
                                    <option value="手工设计">手工设计</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                            <div class="form-group">
                                <label class="form-label">标签</label>
                                <input type="text" class="form-input" id="editTags" name="tags" placeholder="用逗号分隔，如：现代, 简约, 创意">
                            </div>
                            <div class="form-group">
                                <label class="form-label">状态</label>
                                <select class="form-input" id="editStatus" name="status" required>
                                    <option value="draft">草稿</option>
                                    <option value="published">发布</option>
                                </select>
                            </div>
                        </div>

                        <div style="margin-top: 3rem; display: flex; gap: 1rem;">
                            <button type="button" class="btn btn-secondary" onclick="dashboardManager.showSection('my-portfolios')">取消</button>
                            <button type="submit" class="btn btn-primary">
                                <span>💾</span>
                                <span>更新作品</span>
                            </button>
                        </div>
                    </form>
                    
                    <!-- 版本管理部分 -->
                    <div id="versionManagement" class="section" style="margin-top: 3rem; display: none;">
                        <div class="section-header">
                            <h3 class="section-title">版本管理</h3>
                            <button class="btn btn-primary" onclick="showCreateVersionModal()">
                                <span>➕</span>
                                <span>新建版本</span>
                            </button>
                        </div>
                        
                        <div id="versionsList" class="versions-list">
                            <!-- 版本列表将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 个人资料页面 -->
            <div id="profile-section" class="content-section" style="display: none;">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">个人资料</h2>
                    </div>
                    
                    <form id="profileForm" style="max-width: 600px;">
                        <div class="form-group">
                            <label class="form-label">用户名</label>
                            <input type="text" class="form-input" id="profileUsername" name="username" required>
                            <small style="color: var(--text-secondary); margin-top: 0.5rem; display: block;">用户名用于登录</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">昵称</label>
                            <input type="text" class="form-input" id="profileNickname" name="nickname" placeholder="显示昵称" maxlength="50">
                            <small style="color: var(--text-secondary); margin-top: 0.5rem; display: block;">昵称将作为作品作者显示</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">邮箱</label>
                            <input type="email" class="form-input" id="profileEmail" name="email" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">头像URL</label>
                            <input type="url" class="form-input" id="profileAvatar" name="avatar" placeholder="https://example.com/avatar.jpg">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">个人简介</label>
                            <textarea class="form-input" id="profileBio" name="bio" rows="4" placeholder="介绍一下自己..."></textarea>
                        </div>
                        
                        <div style="margin-top: 2rem;">
                            <button type="submit" class="btn btn-primary">
                                <span>💾</span>
                                <span>保存资料</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 设置页面 -->
            <div id="settings-section" class="content-section" style="display: none;">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">设置</h2>
                    </div>
                    
                    <div style="max-width: 600px;">
                        <div class="form-group">
                            <h3>主题设置</h3>
                            <div style="margin-top: 1rem;">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="darkModeToggle"> 启用深色模式
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 2rem;">
                            <h3>通知设置</h3>
                            <div style="margin-top: 1rem;">
                                <label class="checkbox-label">
                                    <input type="checkbox" checked> 接收邮件通知
                                </label>
                            </div>
                            <div style="margin-top: 0.5rem;">
                                <label class="checkbox-label">
                                    <input type="checkbox" checked> 作品获得点赞时通知
                                </label>
                            </div>
                        </div>
                        
                        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                            <button class="btn btn-primary">
                                <span>💾</span>
                                <span>保存设置</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 用户管理页面 -->
            <div id="user-management-section" class="content-section" style="display: none;">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">用户管理</h2>
                        <div class="section-actions">
                            <div class="stats-summary">
                                <span>总用户: <strong id="totalUsersCount">0</strong></span>
                                <span>待审核: <strong id="pendingUsersCount">0</strong></span>
                                <span>已通过: <strong id="approvedUsersCount">0</strong></span>
                            </div>
                        </div>
                    </div>
                    <div id="usersList">
                        <div class="loading">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <span style="margin-left: 1rem;">加载用户...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 作品审核页面 -->
            <div id="portfolio-review-section" class="content-section" style="display: none;">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">作品审核</h2>
                        <div class="section-actions">
                            <select class="form-input" style="width: auto;" id="reviewStatusFilter">
                                <option value="">全部状态</option>
                                <option value="draft">待审核</option>
                                <option value="published">已通过</option>
                                <option value="rejected">已拒绝</option>
                            </select>
                        </div>
                    </div>
                    <div id="reviewPortfoliosList">
                        <div class="loading">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <span style="margin-left: 1rem;">加载作品...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 系统设置页面 -->
            <div id="system-settings-section" class="content-section" style="display: none;">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">系统设置</h2>
                    </div>
                    
                    <div style="max-width: 800px;">
                        <div class="form-group">
                            <h3>审核设置</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                                配置新用户和作品的审核策略
                            </p>
                            
                            <div style="margin-top: 1rem;">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="userApprovalRequired"> 新用户需要管理员审核
                                </label>
                                <small style="display: block; color: var(--text-secondary); margin-top: 0.5rem;">
                                    启用后，新注册用户需要管理员审核通过后才能登录使用
                                </small>
                            </div>
                            
                            <div style="margin-top: 1.5rem;">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="portfolioApprovalRequired"> 新作品需要审核后发布
                                </label>
                                <small style="display: block; color: var(--text-secondary); margin-top: 0.5rem;">
                                    启用后，用户提交的新作品需要管理员审核通过后才会公开显示
                                </small>
                            </div>
                        </div>
                        
                        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                            <button class="btn btn-primary" onclick="saveAdminSettings()">
                                <span>💾</span>
                                <span>保存设置</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 引用新的JavaScript文件 -->
    <script src="/assets/js/common.js"></script>
    <script src="/assets/js/dashboard.js"></script>
    <script src="/assets/js/minio.js"></script>

    <script>
        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 确保所有脚本都已加载
            setTimeout(() => {
                // 检查认证状态
                if (!AuthManager.checkAuth()) {
                    return;
                }
                
                // 确保dashboardManager已初始化
                if (window.dashboardManager) {
                    console.log('Dashboard Manager is ready');
                } else {
                    console.log('Dashboard Manager not found, initializing...');
                    // 如果没有初始化，创建一个基本的导航处理
                    initBasicNavigation();
                }
                
                console.log('Dashboard page initialized with new architecture');
            }, 100);
        });
        
        // 基本导航功能的fallback实现
        function initBasicNavigation() {
            document.addEventListener('click', (e) => {
                const navItem = e.target.closest('.nav-item[data-section]');
                if (navItem) {
                    e.preventDefault();
                    const section = navItem.getAttribute('data-section');
                    showBasicSection(section);
                }
            });
        }
        
        function showBasicSection(sectionName) {
            // 更新导航项激活状态
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeNavItem = document.querySelector(`[data-section="${sectionName}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }

            // 隐藏所有内容区域
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });

            // 显示选定的内容区域
            const targetSection = document.getElementById(`${sectionName}-section`);
            if (targetSection) {
                targetSection.style.display = 'block';
            }

            // 更新页面标题
            const titles = {
                'dashboard': '仪表板',
                'my-portfolios': '我的作品',
                'create-portfolio': '创建作品',
                'profile': '个人资料',
                'settings': '设置',
                'user-management': '用户管理',
                'portfolio-review': '作品审核',
                'system-settings': '系统设置',
                'minio-settings': 'MinIO设置'
            };
            
            const pageTitle = document.getElementById('pageTitle');
            if (pageTitle) {
                pageTitle.textContent = titles[sectionName] || '仪表板';
            }
        }
        
        // 版本管理功能
        let portfolioVersions = [];
        
        // 显示通知
        function showNotification(message, type = 'info') {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                transform: translateX(400px);
                transition: transform 0.3s ease;
                max-width: 300px;
                word-wrap: break-word;
            `;
            
            // 设置颜色
            switch(type) {
                case 'success':
                    notification.style.backgroundColor = '#48bb78';
                    break;
                case 'error':
                    notification.style.backgroundColor = '#f56565';
                    break;
                case 'warning':
                    notification.style.backgroundColor = '#ed8936';
                    break;
                default:
                    notification.style.backgroundColor = '#4299e1';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // 显示动画
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // 自动隐藏
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        // 显示添加版本对话框
        function showAddVersionDialog() {
            const dialog = document.getElementById('addVersionDialog');
            const input = document.getElementById('versionNameInput');
            
            input.value = '';
            dialog.classList.add('show');
            
            // 延迟聚焦，确保模态框完全显示后再聚焦
            setTimeout(() => {
                input.focus();
            }, 100);
        }
        
        // 确认添加版本
        function confirmAddVersion() {
            const input = document.getElementById('versionNameInput');
            const dialog = document.getElementById('addVersionDialog');
            const versionName = input.value.trim();
            
            if (versionName) {
                dialog.classList.remove('show');
                addPortfolioVersion(versionName);
            } else {
                showNotification('请输入版本名称', 'warning');
                input.focus();
            }
        }
        
        // 取消添加版本
        function cancelAddVersion() {
            const dialog = document.getElementById('addVersionDialog');
            dialog.classList.remove('show');
        }
        
        // 添加作品版本
        function addPortfolioVersion(versionName) {
            // 检查版本名是否已存在
            if (portfolioVersions.some(v => v.name === versionName)) {
                showNotification('版本名称已存在，请使用其他名称', 'error');
                return;
            }
            
            // 添加新版本
            const version = {
                id: 'version_' + Date.now(),
                name: versionName,
                htmlContent: ''
            };
            
            portfolioVersions.push(version);
            updateVersionSelect();
            
            // 自动选择新版本
            const versionSelect = document.getElementById('portfolioVersion');
            versionSelect.value = version.id;
            handleVersionChange();
            
            // 显示成功通知
            showNotification(`版本 "${versionName}" 创建成功`, 'success');
        }
        
        // 删除选中的版本
        function deleteSelectedVersion() {
            const versionSelect = document.getElementById('portfolioVersion');
            const selectedVersionId = versionSelect.value;
            
            if (!selectedVersionId) {
                return;
            }
            
            const versionIndex = portfolioVersions.findIndex(v => v.id === selectedVersionId);
            if (versionIndex > -1) {
                const versionName = portfolioVersions[versionIndex].name;
                showDeleteConfirmDialog(versionName, () => {
                    portfolioVersions.splice(versionIndex, 1);
                    updateVersionSelect();
                    
                    // 清空HTML内容
                    document.getElementById('htmlContentEditor').value = '';
                    
                    // 隐藏删除按钮
                    document.getElementById('deleteVersionBtn').style.display = 'none';
                });
            }
        }
        
        // 存储删除回调函数
        let deleteCallback = null;
        
        // 显示删除确认对话框
        function showDeleteConfirmDialog(versionName, onConfirm) {
            const dialog = document.getElementById('deleteConfirmDialog');
            const message = document.getElementById('deleteConfirmMessage');
            
            message.textContent = `确定要删除版本 "${versionName}" 吗？此操作无法撤销。`;
            dialog.classList.add('show');
            
            // 存储回调函数
            deleteCallback = onConfirm;
        }
        
        // 确认删除
        function confirmDelete() {
            const dialog = document.getElementById('deleteConfirmDialog');
            dialog.classList.remove('show');
            
            if (deleteCallback) {
                deleteCallback();
                deleteCallback = null;
            }
        }
        
        // 取消删除
        function cancelDelete() {
            const dialog = document.getElementById('deleteConfirmDialog');
            dialog.classList.remove('show');
            deleteCallback = null;
        }
        
        // 更新版本选择器
        function updateVersionSelect() {
            const versionSelect = document.getElementById('portfolioVersion');
            const currentValue = versionSelect.value;
            
            // 清空选项
            versionSelect.innerHTML = '<option value="">选择或创建版本</option>';
            
            // 添加版本选项
            portfolioVersions.forEach(version => {
                const option = document.createElement('option');
                option.value = version.id;
                option.textContent = version.name;
                versionSelect.appendChild(option);
            });
            
            // 尝试恢复之前选中的值
            if (currentValue && portfolioVersions.some(v => v.id === currentValue)) {
                versionSelect.value = currentValue;
            }
        }
        
        // 处理版本选择变化
        function handleVersionChange() {
            const versionSelect = document.getElementById('portfolioVersion');
            const selectedVersionId = versionSelect.value;
            const deleteBtn = document.getElementById('deleteVersionBtn');
            
            if (selectedVersionId) {
                // 显示删除按钮
                deleteBtn.style.display = 'inline-flex';
                
                // 查找选中的版本
                const selectedVersion = portfolioVersions.find(v => v.id === selectedVersionId);
                if (selectedVersion) {
                    // 加载版本HTML内容到表单
                    document.getElementById('htmlContentEditor').value = selectedVersion.htmlContent || '';
                }
            } else {
                // 隐藏删除按钮
                deleteBtn.style.display = 'none';
                
                // 清空HTML内容
                document.getElementById('htmlContentEditor').value = '';
            }
        }
        
        // 保存当前版本内容
        function saveCurrentVersionContent() {
            const versionSelect = document.getElementById('portfolioVersion');
            const selectedVersionId = versionSelect.value;
            
            if (selectedVersionId) {
                const selectedVersion = portfolioVersions.find(v => v.id === selectedVersionId);
                if (selectedVersion) {
                    selectedVersion.htmlContent = document.getElementById('htmlContentEditor').value;
                }
            }
        }
        
        // 处理创建作品表单提交
        function handleCreatePortfolio(event) {
            event.preventDefault();
            
            const form = document.getElementById('createPortfolioForm');
            const formData = new FormData(form);
            
            // 收集基本作品信息
            const portfolioData = {
                title: formData.get('title'),
                description: formData.get('description'),
                category: formData.get('category'),
                imageUrl: formData.get('imageUrl'),
                aiLevel: formData.get('aiLevel'),
                tags: formData.get('tags') ? formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag) : []
            };
            
            // 收集版本信息
            const versions = [];
            portfolioVersions.forEach((version, index) => {
                versions.push({
                    name: version.name,
                    title: version.name, // 使用版本名作为标题
                    description: '',
                    htmlContent: version.htmlContent || '<p>请添加HTML内容</p>',
                    changeLog: index === 0 ? '初始版本' : '版本更新',
                    isActive: index === 0 // 第一个版本为活跃版本
                });
            });
            
            // 如果没有版本，创建默认版本
            if (versions.length === 0) {
                const htmlContent = document.getElementById('htmlContentEditor').value;
                if (htmlContent.trim()) {
                    versions.push({
                        name: 'v1.0',
                        title: 'v1.0',
                        description: '默认版本',
                        htmlContent: htmlContent,
                        changeLog: '初始版本',
                        isActive: true
                    });
                }
            }
            
            portfolioData.versions = versions;
            
            // 发送请求
            showNotification('正在创建作品...', 'info');
            
            const apiClient = new ApiClient();
            apiClient.request('/portfolios', {
                method: 'POST',
                body: JSON.stringify(portfolioData)
            })
            .then(result => {
                if (result && !result.error) {
                    showNotification('作品创建成功！', 'success');
                    
                    // 清空表单和版本数据
                    form.reset();
                    portfolioVersions = [];
                    updateVersionSelect();
                    
                    // 跳转到我的作品页面
                    setTimeout(() => {
                        dashboardManager.showSection('my-portfolios');
                    }, 1500);
                } else {
                    showNotification(`创建失败: ${result?.error || '未知错误'}`, 'error');
                }
            })
            .catch(error => {
                console.error('创建作品失败:', error);
                showNotification('创建作品失败，请稍后重试', 'error');
            });
        }
        
        // 初始化版本选择器事件
        document.addEventListener('DOMContentLoaded', function() {
            const versionSelect = document.getElementById('portfolioVersion');
            if (versionSelect) {
                versionSelect.addEventListener('change', handleVersionChange);
            }
            
            // 监听HTML内容变化，自动保存到当前版本
            const htmlTextarea = document.getElementById('htmlContentEditor');
            
            if (htmlTextarea) {
                htmlTextarea.addEventListener('blur', saveCurrentVersionContent);
            }
        });
    </script>

    <!-- 添加版本对话框 -->
    <div id="addVersionDialog" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">新建版本</h3>
            </div>
            <div style="padding: 1.5rem 0;">
                <div class="form-group">
                    <label class="form-label">版本名称</label>
                    <input type="text" id="versionNameInput" class="form-input" placeholder="如：v1.0, v2.0, beta等" maxlength="20" onkeypress="if(event.key==='Enter') confirmAddVersion()">
                    <small style="color: var(--text-secondary); margin-top: 0.5rem; display: block;">建议使用语义化版本号</small>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button onclick="cancelAddVersion()" class="btn btn-secondary">
                        <span>❌</span>
                        <span>取消</span>
                    </button>
                    <button onclick="confirmAddVersion()" class="btn btn-primary">
                        <span>➕</span>
                        <span>创建版本</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除确认对话框 -->
    <div id="deleteConfirmDialog" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">确认删除</h3>
            </div>
            <div style="padding: 1.5rem 0;">
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div style="font-size: 3rem; color: #f56565; margin-bottom: 1rem;">⚠️</div>
                    <p id="deleteConfirmMessage" style="margin: 0; color: var(--text-primary); font-size: 1.1rem;"></p>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button onclick="cancelDelete()" class="btn btn-secondary">
                        <span>❌</span>
                        <span>取消</span>
                    </button>
                    <button onclick="confirmDelete()" class="btn btn-danger">
                        <span>🗑️</span>
                        <span>确定删除</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 版本管理模态框 -->
    <div id="versionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="versionModalTitle">新建版本</h3>
                <button class="modal-close" onclick="closeVersionModal()">&times;</button>
            </div>
            <form id="versionForm" style="margin-top: 1rem;">
                <input type="hidden" id="versionPortfolioId">
                <input type="hidden" id="versionId">
                
                <div class="form-group">
                    <label class="form-label">版本标题</label>
                    <input type="text" class="form-input" id="versionTitle" name="title" placeholder="为此版本输入标题" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">版本描述</label>
                    <textarea class="form-input" id="versionDescription" name="description" rows="3" placeholder="描述此版本的特点或改进"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">HTML代码</label>
                    <textarea class="form-input" id="versionHtmlContent" name="htmlContent" rows="12" placeholder="输入此版本的HTML代码..." style="font-family: monospace; font-size: 14px;" required></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">版本更新日志</label>
                    <textarea class="form-input" id="versionChangeLog" name="changeLog" rows="3" placeholder="记录此版本的更新内容"></textarea>
                </div>
                
                <div class="form-group">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="versionIsActive" name="isActive">
                        <label for="versionIsActive" style="margin: 0; cursor: pointer;">设为活跃版本</label>
                    </div>
                    <small style="color: var(--text-secondary); margin-top: 0.25rem; display: block;">活跃版本将在前台展示</small>
                </div>
                
                <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeVersionModal()">取消</button>
                    <button type="submit" class="btn btn-primary">
                        <span id="versionSubmitIcon">➕</span>
                        <span id="versionSubmitText">创建版本</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
{{end}}